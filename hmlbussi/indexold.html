<!DOCTYPE html>
<html lang="fi">

<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Quick Start - Leaflet</title>
    <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="./js/route-to-line.js"></script> <!-- route_to_line -->
    <script src="./js/bus_routes.js"></script> <!-- bus_routes leflet layer -->
    <script src="./js/bus_stops.js"></script> <!-- bus_stops leflet layer -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://unpkg.com/pbf@3.0.5/dist/pbf.js"></script>
    <!-- <script src="https://unpkg.com/gtfs-realtime-pbf-js-module@1.0.0/gtfs-realtime.browser.proto.js"></script>  -->
    <!-- <script src="http://cdn.jsdelivr.net/npm/protobufjs@7.X.X/dist/protobuf.min.js"></script> -->

    <!-- https://dev.to/gavinr/how-to-open-a-gtfs-bus-feed-in-the-browser-kgo -->
    <script src="./js/pbf.js"></script>
    <script src="./js/gtfs-realtime.browser.proto.js"></script>
    <!-- <script src="https://unpkg.com/pbf@3.0.5/dist/pbf.js"></script> 
    <script src="https://unpkg.com/gtfs-realtime-pbf-js-module@1.0.0/gtfs-realtime.browser.proto.js"></script>  -->
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        .leaflet-container {
            height: 1500px;
            width: 900px;
            max-width: 100%;
            max-height: 100%;
        }
    </style>
</head>

<body onload="alusta()">
    <div id="map" style="width: 15000px; height: 900px;"></div>
    <script>
        var nayta_maaseutu = true;
        var nayta_pysakit = false;
        var pysakitlayer = null;

        class Sijainti { //kuvakkeita kartalle ja poistetaan vanhoja automaattisesti jos sijaintia ei päivitetty nn sekuntiin
            constructor(leafmap) {
                var vahtiThis = this;
                this.leafmap = leafmap;
                this.markkerit = {};
                this.locationLayer = new this.leafmap.FeatureGroup()
                this.locationLayer.addTo(map); (this.leafmap);
                this.interval = setInterval(function () {
                    for (let mk in vahtiThis.markkerit) {
                        //console.log(mk, vahtiThis.markkerit[mk].timestamp);
                        if (Date.now() - vahtiThis.markkerit[mk].timestamp > 60000) {//poista vanhat markkerit
                            console.log("DELETE", vahtiThis.markkerit[mk])
                            let iconitem = document.getElementsByClassName("marker_div_" + vahtiThis.markkerit[mk].id)[0];
                            let txtitem = document.getElementsByClassName("marker_text_" + vahtiThis.markkerit[mk].id)[0];
                            iconitem.remove();
                            txtitem.remove();
                            delete vahtiThis.markkerit[mk];
                        }
                    }
                }, 5000);
            }
            setSijainti(id, name, lat, lon, suunta) {
                if (!(id in this.markkerit)) {
                    this.markkerit[id] = {};
                    let iconSettings = {
                        mapIconUrl: '<svg class="ikonimarkkeri_' + id + '" version="1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 149 178"><path class="uusipath" fill="{mapIconColor}" stroke="#FFF" stroke-width="6" stroke-miterlimit="10" d="M126 23l-6-6A69 69 0 0 0 74 1a69 69 0 0 0-51 22A70 70 0 0 0 1 74c0 21 7 38 22 52l43 47c6 6 11 6 16 0l48-51c12-13 18-29 18-48 0-20-8-37-22-51z"/><circle fill="{mapIconColorInnerCircle}" cx="74" cy="75" r="61"/><circle fill="#FFF" cx="74" cy="75" r="{pinInnerCircleRadius}"/></svg>',
                        mapIconColor: '#cc756b',
                        mapIconColorInnerCircle: '#fff',
                        pinInnerCircleRadius: 24
                    }
                    let divIcon = L.divIcon({
                        className: "marker_div_" + id,
                        html: L.Util.template(iconSettings.mapIconUrl, iconSettings),
                        iconAnchor: [13, 13],
                        iconSize: [24, 24],
                        popupAnchor: [0, 0],
                    })
                    this.markkerit[id].marker = L.marker([53, 10], { //ikonimarkkeri
                        icon: divIcon,
                        id: 2        //console.log(mqtt);
                    });

                    this.markkerit[id].textMarker = L.marker([53, 10], { //tekstimarkkeri
                        icon: L.divIcon({
                            html: '<font color="red" size="1">' + name + '</font>',
                            iconAnchor: [7, 7],
                            className: 'marker_text_' + id,
                        })
                    });

                    this.locationLayer.addLayer(this.markkerit[id].marker);
                    this.locationLayer.addLayer(this.markkerit[id].textMarker);
                }
                var newLatLng = new L.LatLng(lat, lon); //siirto
                this.markkerit[id].marker.setLatLng(newLatLng);
                this.markkerit[id].textMarker.setLatLng(newLatLng);

                document.getElementsByClassName("ikonimarkkeri_" + id)[0].setAttribute("transform", "rotate(" + suunta + ")")
                this.markkerit[id].id = id;
                this.markkerit[id].sijainti = [lon, lat];
                this.markkerit[id].name = name
                this.markkerit[id].timestamp = Date.now();
            }
        }
        function polystyle(feature) {
            return {
                fillColor: 'blue',
                weight: 2,
                opacity: 1,
                color: 'black',  //Outline color
                fillOpacity: 0.7
            };
        }
        const map = L.map('map').setView([60.99596, 24.46434], 12);
        const tiles = L.tileLayer('https://b.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        var geojsonLayer = L.geoJSON().addTo(map);
        geojsonLayer.addData(bus_routes);

        function klikEnable() {
            console.log("klikenable");
            geojsonLayer.eachLayer(function (layer) {
                // console.log(layer);
                layer.bindPopup(layer.feature.properties.id);
                layer.on('click', function () {
                    // console.log(this.feature.properties.id);
                });
            });
        }

        function showStops() {
            nayta_pysakit = !nayta_pysakit;
            console.log("showstops", nayta_pysakit);
            if (nayta_pysakit) {
                //PYSÄKIT
                var geojsonMarkerOptions = {
                    radius: 2,
                    fillColor: "#0000ff",
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                };
                pysakitlayer = L.geoJSON(bus_stops, {
                    pointToLayer: function (feature, latlng) {
                        return L.circleMarker(latlng, geojsonMarkerOptions);
                    }
                })
                pysakitlayer.addTo(map); // /PYSÄKIT
            }
            else map.removeLayer(pysakitlayer);
        }

        function varita(varitettavalinja) {
            console.log("varita", varitettavalinja, typeof (varitettavalinja));
            geojsonLayer.eachLayer(layer => {
                let randomColor = "#" + Math.floor(Math.random() * 16777215).toString(16);
                if (layer.feature.properties.id == varitettavalinja) {
                    layer.bringToFront()
                    layer.setStyle({
                        weight: 3,
                        color: '#ff0000',
                        dashArray: '',
                        opacity: 0.5
                    });
                }
                else {
                    let paksuus = 1;
                    if (layer.feature.properties.linjatyyppi == "kaupunki") {
                        paksuus = 4;
                    }
                    else {
                        if (!(nayta_maaseutu)) paksuus = 0;
                    }
                    layer.bringToBack();
                    randomColor = "#3388ff";
                    layer.setStyle({
                        weight: paksuus,
                        color: "#3388ff",
                        dashArray: '',
                        opacity: 0.5
                    });
                }
            });
        }

        function varitaKlik() {
            let varitettava = document.getElementById("linjaselect").value;
            varita(varitettava);
        }

        function alusta() {
            let linjat = ["1", "1S", "2", "2U", "3", "3S", "3K", "4", "5", "10", "10T", "11", "13", "14", "14K", "16", "17", "17K"];
            let select = document.getElementById('linjaselect');
            linjat.forEach(element => {
                var opt = document.createElement('option');
                opt.value = element;
                opt.innerHTML = element;
                select.appendChild(opt);
            });
            setTimeout(
                function () {
                    klikEnable();
                    varita("0");
                    showStops();
                }, 1000);

        }


        function klik(nr) { //--------------------------------
            s.setSijainti(nr, "5", 61.0000, 24.4414, 45);
        }

        function maaseutuOnOff() {
            nayta_maaseutu = !nayta_maaseutu;
            varita("0");
        }

        function siirra(nr) {
            s.setSijainti(nr, "5", 61.0100, 24.4414, 225);
        }

        const s = new Sijainti(L);

        const options = { // mqtt
            clean: true,
            connectTimeout: 4000,
            clientId: 'jiitest',
            username: 'user',
            password: 'userpass',
        }
        const client = mqtt.connect("wss://mqtt.digitransit.fi", options);
        client.on('connect', function () {
            console.log('Connected')
            client.subscribe("/gtfsrt/vp/Hameenlinna/#")
        }


        );
        client.on('disconnect', function () {
            console.log('disConnected')
        }
        );

        client.on('message', function (topic, message) {
            const pbf = new Pbf(new Uint8Array(message));
            const obj = FeedMessage.read(pbf);
            obj.entity.forEach(ms => {
                let linjatxt = route_to_line[ms.vehicle.trip.route_id];
                let suunta = ms.vehicle.position.bearing - 180;
                s.setSijainti(ms.id, linjatxt, ms.vehicle.position.latitude, ms.vehicle.position.longitude, suunta);
            });

        });

    </script>

    <br>
    <select name="linjat" id="linjaselect">
    </select>
    <button onclick="varitaKlik()">väritä</button>
    <button onclick="maaseutuOnOff()">maaseutu</button>
    <button onclick="showStops()">pysäkit</button>

</body>

</html>
